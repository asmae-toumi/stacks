<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting Started With stacks • stacks</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../tidyverse-2.css" rel="stylesheet">
<!--optional theme--><link href="../tidymodels.css" rel="stylesheet">
<meta property="og:title" content="Getting Started With stacks">
<meta property="og:description" content="stacks">
<meta property="og:image" content="https://stacks.tidymodels.org/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">stacks</a>
        <div class="info hidden-xs hidden-sm">
          <span class="partof">part of <a href="https://github.com/tidymodels">tidymodels</a></span>
          <span class="version version-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/basics.html">Getting Started With stacks</a>
    </li>
    <li>
      <a href="../articles/classification.html">Classification Models With stacks</a>
    </li>
  </ul>
</li>
        
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="basics_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Getting Started With stacks</h1>
            
      
      
      <div class="hidden name"><code>basics.Rmd</code></div>

    </div>

    
    
<p>In this article, we’ll be working through an example of the workflow of model stacking with the stacks package. If you’re unfamiliar with the language used in this vignette, please see the package README. At a high level, the workflow looks something like this:</p>
<ol style="list-style-type: decimal">
<li>Define candidate ensemble members using functionality from rsample, parsnip, workflows, recipes, and tune</li>
<li>Initialize a <code>data_stack</code> object with <code><a href="../reference/stacks.html">stacks()</a></code><br>
</li>
<li>Iteratively add candidate ensemble members to the <code>data_stack</code> with <code><a href="../reference/add_candidates.html">add_candidates()</a></code><br>
</li>
<li>Evaluate how to combine their predictions with <code><a href="../reference/blend_predictions.html">blend_predictions()</a></code><br>
</li>
<li>Fit candidate ensemble members with non-zero stacking coefficients with <code><a href="../reference/fit_members.html">fit_members()</a></code><br>
</li>
<li>Predict on new data with <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>!</li>
</ol>
<p>The package is closely integrated with the rest of the functionality in tidymodels—we’ll load those packages as well, in addition to some tidyverse packages to evaluate our results later on.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tidymodels</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">stacks</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span></code></pre></div>
<p>In this example, we’ll make use of the <code>tree_frogs</code> data exported with <code>stacks</code>, giving experimental results on hatching behavior of red-eyed tree frog embryos!</p>
<p>Red-eyed tree frog (RETF) embryos can hatch earlier than their normal 7ish days if they detect potential predator threat. Researchers wanted to determine how, and when, these tree frog embryos were able to detect stimulus from their environment. To do so, they subjected the embryos at varying developmental stages to “predator stimulus” by jiggling the embryos with a blunt probe. Beforehand, though some of the embryos were treated with gentamicin, a compound that knocks out their lateral line (a sensory organ.) Researcher Julie Jung and her crew found that these factors inform whether an embryo hatches prematurely or not!</p>
<p>We’ll start out with predicting <code>latency</code> (i.e. time to hatch) based on other attributes. We’ll need to filter out NAs (i.e. cases where the embryo did not hatch) first.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"tree_frogs"</span><span class="op">)</span>

<span class="co"># subset the data</span>
<span class="va">tree_frogs</span> <span class="op">&lt;-</span> <span class="va">tree_frogs</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">latency</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">clutch</span>, <span class="va">hatched</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Taking a quick look at the data, it seems like the hatch time is pretty closely related to some of our predictors!</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">tree_frogs</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">latency</span>, color <span class="op">=</span> <span class="va">treatment</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Embryo Age (s)"</span>, y <span class="op">=</span> <span class="st">"Time to Hatch (s)"</span>, col <span class="op">=</span> <span class="st">"Treatment"</span><span class="op">)</span></code></pre></div>
<p><img src="basics_files/figure-html/unnamed-chunk-3-1.png" width="768"> Let’s give this a go!</p>
<div id="define-candidate-ensemble-members" class="section level1">
<h1 class="hasAnchor">
<a href="#define-candidate-ensemble-members" class="anchor"></a>Define candidate ensemble members</h1>
<p>Defining the constituent model definitions is undoubtedly the longest part of building an ensemble with <code>stacks</code>. If you’re familiar with tidymodels “proper,” you’re probably fine to skip this section, keeping a few things in mind:</p>
<ul>
<li>You’ll need to save the assessment set predictions and workflow utilized in your <code><a href="https://tune.tidymodels.org/reference/tune_grid.html">tune_grid()</a></code>, <code><a href="https://tune.tidymodels.org/reference/tune_bayes.html">tune_bayes()</a></code>, or <code><a href="https://tune.tidymodels.org/reference/fit_resamples.html">fit_resamples()</a></code> objects by setting the <code>control</code> arguments <code>save_pred = TRUE</code> and <code>save_workflow = TRUE</code>. Note the use of the <code>control_stack_*()</code> convenience functions below!</li>
<li>Each model definition must share the same rsample <code>rset</code> object.</li>
</ul>
<p>We’ll first start out with splitting up the training data, generating resamples, and setting some options that will be used by each model definition.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># some setup: resampling and a basic recipe</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">tree_frogs_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">initial_split</a></span><span class="op">(</span><span class="va">tree_frogs</span><span class="op">)</span>
<span class="va">tree_frogs_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">training</a></span><span class="op">(</span><span class="va">tree_frogs_split</span><span class="op">)</span>
<span class="va">tree_frogs_test</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">testing</a></span><span class="op">(</span><span class="va">tree_frogs_split</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/vfold_cv.html">vfold_cv</a></span><span class="op">(</span><span class="va">tree_frogs_train</span>, v <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>

<span class="va">tree_frogs_rec</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span><span class="va">latency</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">tree_frogs_train</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html">step_dummy</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_nominal</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_zv.html">step_zv</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">tree_frogs_wflow</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://workflows.tidymodels.org//reference/workflow.html">workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://workflows.tidymodels.org//reference/add_recipe.html">add_recipe</a></span><span class="op">(</span><span class="va">tree_frogs_rec</span><span class="op">)</span>

<span class="va">metric</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/metric_set.html">metric_set</a></span><span class="op">(</span><span class="va">rmse</span><span class="op">)</span></code></pre></div>
<p>Tuning and fitting results for use in ensembles need to be fitted with the control arguments <code>save_pred = TRUE</code> and <code>save_workflow = TRUE</code>—these settings ensure that the assessment set predictions, as well as the workflow used to fit the resamples, are stored in the resulting object. For convenience, stacks supplies some <code>control_stack_*()</code> functions to generate the appropriate objects for you.</p>
<p>In this example, we’ll be working with <code><a href="https://tune.tidymodels.org/reference/tune_grid.html">tune_grid()</a></code> and <code><a href="https://tune.tidymodels.org/reference/fit_resamples.html">fit_resamples()</a></code> from the tune package, so we will use the following control settings:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ctrl_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/control_stack_grid.html">control_stack_grid</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">ctrl_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/control_stack_grid.html">control_stack_resamples</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>We’ll define three different model definitions to try to predict time to hatch—a linear model, a spline model (with hyperparameters to tune), and a support vector machine model (again, with hyperparameters to tune).</p>
<p>Starting out with linear regression:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create a linear model definition</span>
<span class="va">lin_reg_spec</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html">linear_reg</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"lm"</span><span class="op">)</span>

<span class="va">lin_reg_wflow</span> <span class="op">&lt;-</span> 
  <span class="va">tree_frogs_wflow</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://workflows.tidymodels.org//reference/add_model.html">add_model</a></span><span class="op">(</span><span class="va">lin_reg_spec</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">lin_reg_res</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tune.tidymodels.org/reference/fit_resamples.html">fit_resamples</a></span><span class="op">(</span>
    <span class="va">lin_reg_wflow</span>,
    resamples <span class="op">=</span> <span class="va">folds</span>,
    metrics <span class="op">=</span> <span class="va">metric</span>,
    control <span class="op">=</span> <span class="va">ctrl_res</span>
  <span class="op">)</span>
<span class="co">#&gt; Loading required package: scales</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'scales'</span>
<span class="co">#&gt; The following object is masked from 'package:purrr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     discard</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'rlang'</span>
<span class="co">#&gt; The following objects are masked from 'package:purrr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     %@%, as_function, flatten, flatten_chr, flatten_dbl, flatten_int,</span>
<span class="co">#&gt;     flatten_lgl, flatten_raw, invoke, list_along, modify, prepend,</span>
<span class="co">#&gt;     splice</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'vctrs'</span>
<span class="co">#&gt; The following object is masked from 'package:tibble':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     data_frame</span>
<span class="co">#&gt; The following object is masked from 'package:dplyr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     data_frame</span>
<span class="co">#&gt; The workflow being saved contains a recipe, which is 0.22 Mb in memory. If this was not intentional, please set the control setting `save_workflow = FALSE`.</span></code></pre></div>
<p>Since this model definition only has one model configuration, we use <code><a href="https://tune.tidymodels.org/reference/fit_resamples.html">fit_resamples()</a></code> rather than <code><a href="https://tune.tidymodels.org/reference/tune_grid.html">tune_grid()</a></code>.</p>
<p>Now, moving on to the spline model definition:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># modify the recipe and use the same linear reg spec</span>
<span class="va">spline_rec</span> <span class="op">&lt;-</span> 
  <span class="va">tree_frogs_rec</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_ns.html">step_ns</a></span><span class="op">(</span><span class="va">age</span>, deg_free <span class="op">=</span> <span class="fu">tune</span><span class="fu">::</span><span class="fu"><a href="https://tune.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="st">"length"</span><span class="op">)</span><span class="op">)</span>

<span class="va">spline_wflow</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://workflows.tidymodels.org//reference/workflow.html">workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://workflows.tidymodels.org//reference/add_recipe.html">add_recipe</a></span><span class="op">(</span><span class="va">spline_rec</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://workflows.tidymodels.org//reference/add_model.html">add_model</a></span><span class="op">(</span><span class="va">lin_reg_spec</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">spline_res</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tune.tidymodels.org/reference/tune_grid.html">tune_grid</a></span><span class="op">(</span>
    <span class="va">spline_wflow</span>,
    resamples <span class="op">=</span> <span class="va">folds</span>,
    metrics <span class="op">=</span> <span class="va">metric</span>,
    control <span class="op">=</span> <span class="va">ctrl_grid</span>
  <span class="op">)</span>
<span class="co">#&gt; The workflow being saved contains a recipe, which is 0.23 Mb in memory. If this was not intentional, please set the control setting `save_workflow = FALSE`.</span></code></pre></div>
<p>Finally, putting together the model definition for the support vector machine:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">svm_spec</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/svm_rbf.html">svm_rbf</a></span><span class="op">(</span>
    cost <span class="op">=</span> <span class="fu"><a href="https://tune.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>, 
    rbf_sigma <span class="op">=</span> <span class="fu"><a href="https://tune.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"kernlab"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_args.html">set_mode</a></span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span>

<span class="va">svm_wflow</span> <span class="op">&lt;-</span> 
  <span class="va">tree_frogs_wflow</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://workflows.tidymodels.org//reference/add_model.html">add_model</a></span><span class="op">(</span><span class="va">svm_spec</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">svm_res</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tune.tidymodels.org/reference/tune_grid.html">tune_grid</a></span><span class="op">(</span>
    <span class="va">svm_wflow</span>, 
    resamples <span class="op">=</span> <span class="va">folds</span>, 
    grid <span class="op">=</span> <span class="fl">5</span>,
    control <span class="op">=</span> <span class="va">ctrl_grid</span>
  <span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'kernlab'</span>
<span class="co">#&gt; The following object is masked from 'package:scales':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     alpha</span>
<span class="co">#&gt; The following object is masked from 'package:ggplot2':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     alpha</span>
<span class="co">#&gt; The following object is masked from 'package:purrr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     cross</span>
<span class="co">#&gt; The workflow being saved contains a recipe, which is 0.22 Mb in memory. If this was not intentional, please set the control setting `save_workflow = FALSE`.</span></code></pre></div>
<p>With these three model definitions fully specified, we’re ready to start putting together an ensemble!</p>
</div>
<div id="putting-together-a-stack" class="section level1">
<h1 class="hasAnchor">
<a href="#putting-together-a-stack" class="anchor"></a>Putting together a stack</h1>
<p>The first step to building an ensemble with stacks is to create a <code>data_stack</code> object—in this package, data stacks are tibbles (with some extra attributes) that contain the assessment set predictions for each candidate ensemble member.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/stacks.html">stacks</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A data stack with 0 model definitions and 0 candidate members.</span></code></pre></div>
<p>The <code><a href="../reference/stacks.html">stacks()</a></code> function works sort of like the <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot()</a></code> constructor from ggplot2—the function creates a basic structure that the object will be built on top of—except you’ll pipe the outputs rather than adding them with <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code>.</p>
<p>The <code><a href="../reference/add_candidates.html">add_candidates()</a></code> function adds ensemble members to the stack.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tree_frogs_data_st</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/stacks.html">stacks</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/add_candidates.html">add_candidates</a></span><span class="op">(</span><span class="va">lin_reg_res</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/add_candidates.html">add_candidates</a></span><span class="op">(</span><span class="va">spline_res</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/add_candidates.html">add_candidates</a></span><span class="op">(</span><span class="va">svm_res</span><span class="op">)</span>

<span class="va">tree_frogs_data_st</span>
<span class="co">#&gt; # A data stack with 3 model definitions and 15 candidate members:</span>
<span class="co">#&gt; #   lin_reg_res: 1 model configuration</span>
<span class="co">#&gt; #   spline_res: 9 model configurations</span>
<span class="co">#&gt; #   svm_res: 5 model configurations</span>
<span class="co">#&gt; # Outcome: latency (numeric)</span></code></pre></div>
<p>As mentioned before, under the hood, a <code>data_stack</code> object is really just a tibble with some extra attributes. Checking out the actual data:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">tree_frogs_data_st</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 429 x 16</span>
<span class="co">#&gt;    latency lin_reg_res_1_1 spline_res_5_1 spline_res_7_1 spline_res_8_1</span>
<span class="co">#&gt;      &lt;dbl&gt;           &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;</span>
<span class="co">#&gt;  1     360           194.           201.           200.           199. </span>
<span class="co">#&gt;  2     106           123.           122.           123.           123. </span>
<span class="co">#&gt;  3     180           138.           132.           132.           133. </span>
<span class="co">#&gt;  4      60           122.           114.           115.           116. </span>
<span class="co">#&gt;  5      39            82.9           83.7           83.0           83.4</span>
<span class="co">#&gt;  6     214           134.           117.           118.           112. </span>
<span class="co">#&gt;  7      50            37.2           30.5           29.0           30.8</span>
<span class="co">#&gt;  8     224           125.           121.           122.           121. </span>
<span class="co">#&gt;  9      63            40.3           37.1           37.3           37.9</span>
<span class="co">#&gt; 10      33            38.3           33.1           33.1           34.1</span>
<span class="co">#&gt; # … with 419 more rows, and 11 more variables: spline_res_2_1 &lt;dbl&gt;,</span>
<span class="co">#&gt; #   spline_res_3_1 &lt;dbl&gt;, spline_res_4_1 &lt;dbl&gt;, spline_res_1_1 &lt;dbl&gt;,</span>
<span class="co">#&gt; #   spline_res_6_1 &lt;dbl&gt;, spline_res_9_1 &lt;dbl&gt;, svm_res_1_4 &lt;dbl&gt;,</span>
<span class="co">#&gt; #   svm_res_1_2 &lt;dbl&gt;, svm_res_1_3 &lt;dbl&gt;, svm_res_1_5 &lt;dbl&gt;, svm_res_1_1 &lt;dbl&gt;</span></code></pre></div>
<p>The first column gives the first response value, and the remaining columns give the assessment set predictions for each ensemble member. Since we’re in the regression case, there’s only one column per ensemble member. In classification settings, there are as many columns as there are levels of the outcome variable per candidate ensemble member.</p>
<p>That’s it! We’re now ready to evaluate how it is that we need to combine predictions from each candidate ensemble member.</p>
</div>
<div id="fit-the-stack" class="section level1">
<h1 class="hasAnchor">
<a href="#fit-the-stack" class="anchor"></a>Fit the stack</h1>
<p>The outputs from each of these candidate ensemble members are highly correlated, so the <code>blend_predictions</code> method performs regularization to figure out how we can combine the outputs from the stack members to come up with a final prediction.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tree_frogs_model_st</span> <span class="op">&lt;-</span>
  <span class="va">tree_frogs_data_st</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/blend_predictions.html">blend_predictions</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: Matrix</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'Matrix'</span>
<span class="co">#&gt; The following objects are masked from 'package:tidyr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     expand, pack, unpack</span>
<span class="co">#&gt; Loaded glmnet 4.0-2</span></code></pre></div>
<p>The <code>blend_predictions</code> function determines how member model output will ultimately be combined in the final prediction. Now that we know how to combine our model output, we can fit the models that we now know we need.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tree_frogs_model_st</span> <span class="op">&lt;-</span>
  <span class="va">tree_frogs_model_st</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/fit_members.html">fit_members</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This object is now ready to predict with new data!</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tree_frogs_test</span> <span class="op">&lt;-</span> 
  <span class="va">tree_frogs_test</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_frogs_model_st</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Juxtaposing the predictions with the true data:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">tree_frogs_test</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">latency</span>, 
      y <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://tune.tidymodels.org/reference/coord_obs_pred.html">coord_obs_pred</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="basics_files/figure-html/unnamed-chunk-15-1.png" width="768"></p>
<p>Looks like our predictions were pretty strong! How do the stacks predictions perform, though, as compared to the members’ predictions? We can use the <code>type = "members"</code> argument to generate predictions from each of the ensemble members.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">member_preds</span> <span class="op">&lt;-</span> 
  <span class="va">tree_frogs_test</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">latency</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_frogs_model_st</span>, <span class="va">tree_frogs_test</span>, members <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Now, evaluating the root mean squared error from each model:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span><span class="op">(</span><span class="va">member_preds</span>, <span class="va">rmse</span>, truth <span class="op">=</span> <span class="va">latency</span>, data <span class="op">=</span> <span class="va">member_preds</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>member <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">member_preds</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 7 x 4</span>
<span class="co">#&gt;   .metric .estimator .estimate member        </span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;         </span>
<span class="co">#&gt; 1 rmse    standard         0   latency       </span>
<span class="co">#&gt; 2 rmse    standard        43.7 .pred         </span>
<span class="co">#&gt; 3 rmse    standard        43.1 spline_res_9_1</span>
<span class="co">#&gt; 4 rmse    standard        59.5 svm_res_1_4   </span>
<span class="co">#&gt; 5 rmse    standard        44.9 svm_res_1_3   </span>
<span class="co">#&gt; 6 rmse    standard        59.2 svm_res_1_5   </span>
<span class="co">#&gt; 7 rmse    standard        59.5 svm_res_1_1</span></code></pre></div>
<p>As we can see, the stacked ensemble outperforms each of the member models, though is closely followed by one of the spline members.</p>
<p>Voila! You’ve now made use of the stacks package to predict red-eyed tree frog embryo hatching using a stacked ensemble!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="tidyverse">
  <p>stacks is a part of the <strong>tidymodels</strong> ecosystem, a collection of modeling packages designed with common APIs and a shared philosophy.</p>
</div>

<div class="author">
  <p>
    Developed by Simon Couch, Max Kuhn.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
